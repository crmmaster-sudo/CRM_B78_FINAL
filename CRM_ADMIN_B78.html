<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CRM ADMIN</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#f3f8ff; --card:#fff; --accent:#3b82f6; --muted:#666;
    --success:#16a34a; --danger:#ef4444; --warning:#f59e0b;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,sans-serif}
  body{margin:0;background:var(--bg);color:#1b1b1b}
  header{padding:16px 24px;display:flex;align-items:center;justify-content:space-between;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.05)}
  .app{max-width:1200px;margin:20px auto;padding:20px}
  .card{background:var(--card);border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,.06);margin-bottom:20px}
  input,select{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-top:6px;font-size:14px}
  button{padding:10px 16px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer;font-size:14px;font-weight:500}
  button.danger{background:var(--danger)}
  button.success{background:var(--success)}
  button.warning{background:var(--warning)}
  button.info{background:#6b7280}
  .cols{display:grid;grid-template-columns:1fr 380px;gap:20px;margin-top:20px}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:12px 8px;border-bottom:1px solid #eee;text-align:left;vertical-align:middle}
  .badge{padding:4px 8px;border-radius:6px;font-size:11px;font-weight:600}
  .aktif{background:#dcfce7;color:#166534}
  .normal{background:#fef9c3;color:#854d0e}
  .jarang{background:#fee2e2;color:#991b1b}
  .filter-bar{display:flex;gap:8px;flex-wrap:wrap;margin:16px 0;align-items:center}
  .search-bar{display:flex;gap:8px;margin-bottom:16px;align-items:center}
  .summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:20px}
  .summary-card{text-align:center;background:#f9fafb;box-shadow:none;padding:20px}
  .summary-value{font-size:24px;font-weight:700;margin:8px 0}
  .summary-label{font-size:14px;color:#666;margin-bottom:4px}
  .chart-container{margin:20px 0;min-height:200px}
  input[type="checkbox"]{transform:scale(1.2);margin:0 4px}
  th{background:#f8fafc;font-weight:600;font-size:13px}
  .sheet-message{display:none; padding:12px; border-radius:8px; font-size:13px; text-align:center; margin-top:12px}
  .sheet-info{background:#eff6ff;border:1px solid #dbeafe;color:#1e40af;padding:12px;border-radius:8px;margin-bottom:16px;font-size:13px}
  .form-group{margin-bottom:16px}
  .form-label{font-weight:500;display:block;margin-bottom:6px;color:#374151}
  .manual-process{background:#fff7ed;border:1px solid #fdba74;color:#9a3412;padding:16px;border-radius:8px;margin:16px 0;font-size:14px;line-height:1.6}
  .manual-steps{background:#fffbeb;padding:12px;border-radius:6px;margin:12px 0}
  .date-info{background:#f0f9ff;border:1px solid #bae6fd;color:#0369a1;padding:8px 12px;border-radius:6px;font-size:12px;margin:8px 0}
  .chart-actions{display:flex;gap:8px;margin:10px 0;justify-content:center}
  .time-travel-banner{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:12px 16px;border-radius:8px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center}
  .time-travel-banner button{background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3)}
  .time-travel-banner button:hover{background:rgba(255,255,255,0.3)}
  .reset-section{background:#fef2f2;border:1px solid #fecaca;padding:16px;border-radius:8px;margin:16px 0}
  .reset-buttons{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
</style>
</head>
<body>
<header>
  <div style="font-weight:700;font-size:18px">CRM ADMIN</div>
  <div id="signedOut"><button onclick="showLogin()">Login</button></div>
  <div id="signedIn" style="display:none;align-items:center;gap:12px">
    <div id="adminName"></div>
    <button onclick="logout()">Logout</button>
  </div>
</header>

<div class="app">
  <!-- LOGIN -->
  <div id="loginBox" class="card" style="max-width:400px;margin:80px auto">
    <h2 style="text-align:center;margin-bottom:20px">Login Admin</h2>
    <input id="loginUser" placeholder="Username" value="admin1" style="margin-bottom:12px"/>
    <input id="loginPass" type="password" placeholder="Password" value="admin123" style="margin-bottom:16px"/>
    <button onclick="doLogin()" style="width:100%;padding:12px">Masuk</button>
    <div id="loginMsg" style="color:red;margin-top:12px;text-align:center"></div>
  </div>

  <!-- MAIN -->
  <div id="mainUI" style="display:none">
    <!-- TIME TRAVEL BANNER -->
    <div id="timeTravelBanner" class="time-travel-banner" style="display:none">
      <div>
        <strong>üïí MODE TIME TRAVEL</strong>
        <div id="timeTravelDateInfo">Anda sedang melihat data pada tanggal: <strong id="currentTravelDate">-</strong></div>
      </div>
      <button onclick="exitTimeTravel()" class="warning">Kembali ke Tanggal Sekarang</button>
    </div>

    <!-- Dashboard Pendapatan -->
    <div class="card">
      <h3 style="margin-bottom:16px">Dashboard Pendapatan</h3>
      
      <div class="filter-bar">
        <input type="date" id="fromDate" style="width:150px"/>
        <input type="date" id="toDate" style="width:150px"/>
        <button onclick="refreshChart()">Terapkan Filter</button>
        <button onclick="showAllHistoricalData()" class="info">Lihat Semua Data</button>
        <button onclick="searchDepositByDate()" class="warning">Cari Tanggal</button>
        <button onclick="openTimeTravel()" class="success" style="background:#8b5cf6">üïí Time Travel</button>
        <button onclick="importFromMaster()">Terima dari Master</button>
      </div>

      <div class="date-info" id="dateRangeInfo">
        Menampilkan semua data historis
      </div>

      <div class="chart-container">
        <canvas id="omsetChart" height="150"></canvas>
      </div>

      <div class="chart-actions">
        <button onclick="showMonthlyView()" class="info">Tampilan Bulanan</button>
        <button onclick="showWeeklyView()" class="info">Tampilan Mingguan</button>
        <button onclick="showDailyView()" class="info">Tampilan Harian</button>
      </div>
      
      <div class="summary-grid">
        <div class="card summary-card">
          <div class="summary-label" id="totalDepositLabel">Total Jumlah Deposit</div>
          <div id="totalDepositToday" class="summary-value" style="color:#3b82f6;">Rp 0</div>
          <small id="summaryDate" style="color:#666;">Semua waktu</small>
        </div>
        <div class="card summary-card">
          <div class="summary-label" id="totalMemberLabel">Total Member Deposit</div>
          <div id="totalMemberToday" class="summary-value" style="color:#16a34a;">0 Member</div>
          <small style="color:#666;" id="memberDepositDesc">Melakukan deposit</small>
        </div>
      </div>

      <!-- RESET DATA SECTION -->
      <div class="reset-section">
        <h4 style="margin:0 0 12px 0;color:#dc2626">‚ö†Ô∏è Reset Data Admin</h4>
        <p style="margin:0 0 12px 0;font-size:14px;color:#7f1d1d">
          Hati-hati! Tindakan reset data tidak dapat dibatalkan. Pilih opsi reset sesuai kebutuhan:
        </p>
        <div class="reset-buttons">
          <button onclick="resetDataByDate()" class="danger" style="background:#dc2626">üóëÔ∏è Reset per Tanggal</button>
          <button onclick="resetDataByDateRange()" class="danger" style="background:#b91c1c">üóëÔ∏è Reset per Rentang</button>
          <button class="danger" onclick="resetAdminData()" style="background:#991b1b">üí• Reset Semua Data</button>
        </div>
        <small style="color:#7f1d1d;display:block;margin-top:8px">
          ‚Ä¢ Reset per Tanggal: Hapus data di tanggal spesifik<br>
          ‚Ä¢ Reset per Rentang: Hapus data dalam rentang tanggal<br>
          ‚Ä¢ Reset Semua: Hapus SEMUA data admin
        </small>
      </div>
    </div>

    <div class="cols">
      <!-- Database Member -->
      <div class="card">
        <h3 style="margin-bottom:16px">Database Member</h3>
        <p id="memberCount" style="font-weight:600;color:#555;margin-bottom:16px">Total data: 0 member</p>
        
        <div class="search-bar">
          <input id="searchMember" placeholder="Cari ID/Nama..." oninput="refreshMembers()" 
                 style="padding:10px 12px;width:250px;border:1px solid #ddd;border-radius:8px">
          <select id="statusFilter" onchange="refreshMembers()" 
                  style="padding:10px 12px;width:150px;border:1px solid #ddd;border-radius:8px">
            <option value="">Semua Status</option>
            <option value="aktif">Aktif</option>
            <option value="normal">Normal</option>
            <option value="jarang">Jarang</option>
          </select>
          <button onclick="refreshMembers()" class="info">Refresh</button>
        </div>

        <div style="overflow-x:auto; border:1px solid #eee; border-radius:8px;">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Nama</th>
                <th>HP</th>
                <th>Last Deposit</th>
                <th>Status</th>
                <th>HP Valid</th>
                <th>No HP Tidak Valid</th>
                <th>Sudah Deposit</th>
                <th>Belum Deposit</th>
                <th>Ada Respon</th>
                <th>Tidak Respon</th>
              </tr>
            </thead>
            <tbody id="memberTable"></tbody>
          </table>
        </div>
      </div>

      <!-- Right Column -->
      <div>
        <!-- Manual Google Drive Process -->
        <div class="card">
          <h3 style="margin-bottom:16px">üìÅ Simpan ke Google Drive</h3>
          
          <div class="manual-process">
            <strong>Proses Manual Sederhana:</strong>
            <div class="manual-steps">
              1Ô∏è‚É£ <strong>Download File Excel</strong> (tombol di bawah)<br>
              2Ô∏è‚É£ <strong>Buka drive.google.com</strong><br>
              3Ô∏è‚É£ <strong>Upload file Excel</strong> yang sudah didownload<br>
              4Ô∏è‚É£ <strong>Selesai!</strong> File sudah ada di Google Drive
            </div>
          </div>
          
          <div style="margin:16px 0; text-align:center">
            <button onclick="downloadForGoogleDrive()" class="success" style="padding:12px 24px; font-size:16px">
              üì• Download untuk Google Drive
            </button>
          </div>
          
          <div style="color:#666; font-size:13px; line-height:1.5; text-align:center">
            <strong>Keuntungan:</strong><br>
            ‚Ä¢ File tersimpan dengan format tanggal<br>
            ‚Ä¢ Kontrol penuh atas file di Google Drive<br>
            ‚Ä¢ Bisa pilih folder sendiri<br>
            ‚Ä¢ Bisa rename file sesuai kebutuhan
          </div>
          
          <div id="sheetMessage" class="sheet-message"></div>
        </div>

        <!-- Tambah Deposit -->
        <div class="card">
          <h3 style="margin-bottom:16px">Tambah Deposit</h3>
          
          <div class="form-group">
            <label class="form-label">Pilih Member</label>
            <select id="depositMember" style="padding:10px">
              <option value="">-- pilih --</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Atau Nama Manual</label>
            <input id="depositManual" placeholder="Nama luar database" style="padding:10px"/>
          </div>
          
          <div class="form-group">
            <label class="form-label">Nominal</label>
            <input id="depositAmount" type="text" placeholder="100000" style="padding:10px"/>
          </div>

          <div class="form-group">
            <label class="form-label">Tanggal Deposit</label>
            <input type="date" id="depositDate" style="padding:10px"/>
            <small style="color:#666;">Kosongkan untuk tanggal hari ini</small>
          </div>
          
          <button onclick="addDeposit()" style="width:100%;padding:12px">Tambah Deposit</button>
          <div id="timeTravelWarning" style="display:none; background:#fef3c7; border:1px solid #fcd34d; color:#92400e; padding:8px; border-radius:6px; margin-top:8px; font-size:12px; text-align:center">
            ‚ö†Ô∏è Mode Time Travel: Deposit baru akan ditambahkan ke tanggal saat ini
          </div>
        </div>

        <!-- Riwayat Deposit -->
        <div class="card">
          <h4 style="margin-bottom:16px">Riwayat Deposit</h4>
          <div class="search-bar">
            <input id="searchDeposit" placeholder="Cari nama/nominal..." oninput="refreshDeposits()" 
                   style="padding:8px 12px;width:200px;border:1px solid #ddd;border-radius:8px">
            <button onclick="refreshDeposits()" class="info">Refresh</button>
          </div>
          <div style="overflow-x:auto; border:1px solid #eee; border-radius:8px;">
            <table>
              <thead>
                <tr>
                  <th>Tgl</th>
                  <th>Member</th>
                  <th>Jumlah</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody id="depositTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ==================== KONFIGURASI SUPA BASE ====================
const SUPABASE_URL = 'https://qclwmenzzzgzrrjuznql.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjbHdtZW56enpnenJyanV6bnFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNzM5MTgsImV4cCI6MjA3NTk0OTkxOH0.Gye11m1kIvDqaKBdKWHFpX17vTdlQrRE5bODf8fwPW0';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let currentAdmin = null;
let state = { members: [], deposits: [] };
let chartInstance = null;
let currentView = 'daily'; // 'daily', 'weekly', 'monthly'
let isTimeTravelMode = false;
let currentTravelDate = null;
let originalState = { members: [], deposits: [] };

// ==================== FIX TIMEZONE FUNCTIONS ====================
function formatDateForDisplay(dateString) {
  if (!dateString) return '-';
  
  // FIX: Split manual untuk hindari timezone issue
  const [year, month, day] = dateString.split('-');
  const date = new Date(year, month - 1, day); // month - 1 karena JavaScript month 0-based
  
  return date.toLocaleDateString('id-ID', {
    day: 'numeric',
    month: 'long', 
    year: 'numeric'
  });
}

function getCurrentLocalDate() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function getMemberStatus(lastDeposit) {
  if (!lastDeposit) return 'jarang';
  
  // FIX: Handle timezone issue
  const [year, month, day] = lastDeposit.split('-');
  const last = new Date(year, month - 1, day);
  const now = new Date();
  
  // Reset waktu ke 00:00:00 untuk perbandingan tanggal murni
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  
  const diff = (today - last) / (1000 * 60 * 60 * 24);
  if (diff <= 7) return 'aktif';
  if (diff <= 30) return 'normal';
  return 'jarang';
}

function formatDate(dateString) {
  if (!dateString) return '-';
  // FIX: Gunakan fungsi yang sama untuk konsistensi
  return formatDateForDisplay(dateString);
}

// ==================== FUNGSI RESET DATA BERDASARKAN TANGGAL ====================
async function resetDataByDate() {
  // Minta tanggal yang ingin direset
  const resetDate = prompt('Masukkan tanggal yang ingin direset datanya (YYYY-MM-DD):\n\nHanya data pada tanggal ini yang akan dihapus.');
  
  if (!resetDate) return;

  // Validasi format tanggal
  const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
  if (!dateRegex.test(resetDate)) {
    alert('Format tanggal tidak valid. Gunakan format YYYY-MM-DD');
    return;
  }

  // Konfirmasi ulang
  if (!confirm(`‚ö†Ô∏è HAPUS DATA PADA TANGGAL ${resetDate}?\n\nTindakan ini akan menghapus SEMUA deposit yang terjadi pada tanggal ${resetDate}.\nTindakan ini tidak dapat dibatalkan!`)) {
    return;
  }

  try {
    // Hapus deposit pada tanggal tersebut
    const { error: depositError } = await supabase
      .from('deposits')
      .delete()
      .eq('admin_username', currentAdmin.username)
      .eq('date', resetDate);

    if (depositError) throw depositError;

    // Refresh data
    await loadAdminData();
    
    // Jika dalam mode time travel, refresh juga
    if (isTimeTravelMode) {
      filterDataForTimeTravel(currentTravelDate);
    }

    refreshMembers();
    refreshDeposits();
    refreshChart();
    refreshDailySummary();

    alert(`‚úÖ Data pada tanggal ${resetDate} berhasil direset!`);

  } catch (error) {
    console.error('Error resetting data by date:', error);
    alert('Error reset data pada tanggal tersebut');
  }
}

async function resetDataByDateRange() {
  const fromDate = prompt('Masukkan tanggal AWAL rentang yang ingin direset (YYYY-MM-DD):');
  if (!fromDate) return;

  const toDate = prompt('Masukkan tanggal AKHIR rentang yang ingin direset (YYYY-MM-DD):');
  if (!toDate) return;

  // Validasi format tanggal
  const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
  if (!dateRegex.test(fromDate) || !dateRegex.test(toDate)) {
    alert('Format tanggal tidak valid. Gunakan format YYYY-MM-DD');
    return;
  }

  if (fromDate > toDate) {
    alert('Tanggal awal tidak boleh lebih besar dari tanggal akhir');
    return;
  }

  if (!confirm(`‚ö†Ô∏è HAPUS DATA DARI ${fromDate} HINGGA ${toDate}?\n\nTindakan ini akan menghapus SEMUA deposit dalam rentang tanggal tersebut.\nTindakan ini tidak dapat dibatalkan!`)) {
    return;
  }

  try {
    const { error: depositError } = await supabase
      .from('deposits')
      .delete()
      .eq('admin_username', currentAdmin.username)
      .gte('date', fromDate)
      .lte('date', toDate);

    if (depositError) throw depositError;

    await loadAdminData();
    
    if (isTimeTravelMode) {
      filterDataForTimeTravel(currentTravelDate);
    }

    refreshMembers();
    refreshDeposits();
    refreshChart();
    refreshDailySummary();

    alert(`‚úÖ Data dari ${fromDate} hingga ${toDate} berhasil direset!`);

  } catch (error) {
    console.error('Error resetting data by date range:', error);
    alert('Error reset data pada rentang tanggal tersebut');
  }
}

// ==================== TIME TRAVEL FUNCTIONS ====================
function openTimeTravel() {
  const travelDate = prompt('Masukkan tanggal yang ingin Anda kunjungi (YYYY-MM-DD):');
  if (!travelDate) return;

  // Validasi format tanggal
  const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
  if (!dateRegex.test(travelDate)) {
    alert('Format tanggal tidak valid. Gunakan format YYYY-MM-DD');
    return;
  }

  // Validasi tanggal tidak di masa depan
  const today = getCurrentLocalDate();
  if (travelDate > today) {
    alert('Tidak bisa melakukan time travel ke masa depan!');
    return;
  }

  enterTimeTravelMode(travelDate);
}

function enterTimeTravelMode(travelDate) {
  isTimeTravelMode = true;
  currentTravelDate = travelDate;
  
  // Simpan state asli
  originalState = {
    members: [...state.members],
    deposits: [...state.deposits]
  };

  // Filter data untuk tanggal time travel
  filterDataForTimeTravel(travelDate);
  
  // Tampilkan banner time travel
  document.getElementById('timeTravelBanner').style.display = 'flex';
  document.getElementById('currentTravelDate').textContent = formatDateForDisplay(travelDate);
  document.getElementById('timeTravelWarning').style.display = 'block';
  
  // Update UI
  refreshMembers();
  refreshDeposits();
  refreshChart();
  refreshDailySummary();
}

function exitTimeTravel() {
  isTimeTravelMode = false;
  currentTravelDate = null;
  
  // Kembalikan ke state asli
  state.members = [...originalState.members];
  state.deposits = [...originalState.deposits];
  
  // Sembunyikan banner time travel
  document.getElementById('timeTravelBanner').style.display = 'none';
  document.getElementById('timeTravelWarning').style.display = 'none';
  
  // Update UI
  refreshMembers();
  refreshDeposits();
  refreshChart();
  refreshDailySummary();
}

function filterDataForTimeTravel(travelDate) {
  // Filter deposits: hanya yang tanggalnya <= travelDate
  const filteredDeposits = state.deposits.filter(d => d.date <= travelDate);
  
  // Untuk members, kita perlu menghitung last_deposit berdasarkan filtered deposits
  const memberDeposits = {};
  
  filteredDeposits.forEach(deposit => {
    if (!deposit.member_id.startsWith('manual_')) {
      if (!memberDeposits[deposit.member_id] || deposit.date > memberDeposits[deposit.member_id]) {
        memberDeposits[deposit.member_id] = deposit.date;
      }
    }
  });

  // Update state untuk time travel
  state.deposits = filteredDeposits;
  
  // Update last_deposit untuk members berdasarkan filtered data
  state.members.forEach(member => {
    if (memberDeposits[member.id]) {
      member.last_deposit = memberDeposits[member.id];
    } else {
      // Jika tidak ada deposit pada/before travelDate, set last_deposit ke null
      member.last_deposit = null;
    }
  });
}

// ==================== MANUAL GOOGLE DRIVE PROCESS ====================
function downloadForGoogleDrive() {
  if (!currentAdmin) {
    alert('Silakan login terlebih dahulu');
    return;
  }

  try {
    showSheetMessage('üìä Membuat file Excel...', true);
    
    const today = new Date();
    const dateStr = today.toLocaleDateString('id-ID').replace(/\//g, '-');
    const fileName = `CRM_Data_${currentAdmin.username}_${dateStr}.xlsx`;
    
    const wb = XLSX.utils.book_new();
    
    const memberData = state.members.map(m => ({
      'ID Member': extractOriginalId(m.id),
      'Nama Lengkap': m.name,
      'Nomor HP': m.phone,
      'Terakhir Deposit': m.last_deposit,
      'Status': getMemberStatus(m.last_deposit),
      'HP Valid': m.hp_valid ? 'Ya' : 'Tidak',
      'Deposit Valid': m.deposit_valid ? 'Ya' : 'Tidak',
      'Ada Respon': m.has_response ? 'Ya' : 'Tidak',
      'Keterangan': getMemberNotes(m)
    }));
    
    const wsMembers = XLSX.utils.json_to_sheet(memberData);
    XLSX.utils.book_append_sheet(wb, wsMembers, "Data Member");
    
    const depositData = state.deposits.map(d => ({
      'Tanggal': d.date,
      'ID Member': d.member_id.startsWith('manual_') ? 'MANUAL' : extractOriginalId(d.member_id),
      'Nama Member': d.member_id.startsWith('manual_') ? d.member_name : (state.members.find(m => m.id === d.member_id)?.name || '-'),
      'Jumlah Deposit': d.amount,
      'Format Rupiah': formatCurrency(d.amount),
      'Tipe': d.member_id.startsWith('manual_') ? 'Manual' : 'Member'
    }));
    
    const wsDeposits = XLSX.utils.json_to_sheet(depositData);
    XLSX.utils.book_append_sheet(wb, wsDeposits, "Riwayat Deposit");
    
    const totalPendapatan = state.deposits.reduce((sum, d) => sum + d.amount, 0);
    
    let periodInfo = 'Semua Data Historis';
    if (isTimeTravelMode) {
      periodInfo = `Mode Time Travel - Data hingga ${formatDateForDisplay(currentTravelDate)}`;
    } else {
      const from = document.getElementById('fromDate').value;
      const to = document.getElementById('toDate').value;
      if (from || to) {
        periodInfo = `Periode: ${from || 'Awal'} - ${to || 'Sekarang'}`;
      }
    }

    const summaryData = [
      ['LAPORAN CRM ADMIN'],
      [''],
      ['Admin:', currentAdmin.username],
      ['Nama Admin:', currentAdmin.name || '-'],
      ['Tanggal Export:', new Date().toLocaleString('id-ID')],
      ['Mode:', isTimeTravelMode ? `Time Travel (hingga ${currentTravelDate})` : 'Normal'],
      ['Rentang Data:', periodInfo],
      [''],
      ['STATISTIK DATA:'],
      ['Total Member:', state.members.length],
      ['Total Transaksi Deposit:', state.deposits.length],
      ['Total Pendapatan:', `Rp ${totalPendapatan.toLocaleString('id-ID')}`],
      ['Rata-rata per Transaksi:', `Rp ${state.deposits.length > 0 ? Math.round(totalPendapatan / state.deposits.length).toLocaleString('id-ID') : '0'}`],
      [''],
      ['STATUS MEMBER:'],
      ['Member Aktif (‚â§7 hari):', state.members.filter(m => getMemberStatus(m.last_deposit) === 'aktif').length],
      ['Member Normal (‚â§30 hari):', state.members.filter(m => getMemberStatus(m.last_deposit) === 'normal').length],
      ['Member Jarang (>30 hari):', state.members.filter(m => getMemberStatus(m.last_deposit) === 'jarang').length],
      [''],
      ['INSTRUKSI:'],
      ['1. Simpan file ini di komputer Anda'],
      ['2. Buka drive.google.com'],
      ['3. Upload file ini ke Google Drive'],
      ['4. File Anda sudah aman di cloud!'],
      [''],
      ['File ini auto-generate dari CRM ADMIN'],
      ['Terakhir update:', new Date().toLocaleString('id-ID')]
    ];
    
    const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
    XLSX.utils.book_append_sheet(wb, wsSummary, "Summary Laporan");
    
    XLSX.writeFile(wb, fileName);
    
    showSheetMessage('‚úÖ File Excel berhasil didownload!', true);
    
    setTimeout(() => {
      if (confirm(`File "${fileName}" berhasil didownload!\n\nSekarang buka Google Drive untuk upload file?\n\nKlik OK untuk membuka drive.google.com`)) {
        window.open('https://drive.google.com', '_blank');
      }
    }, 1000);
    
  } catch (error) {
    console.error('Download error:', error);
    showSheetMessage('‚ùå Gagal membuat file Excel', false);
  }
}

function getMemberNotes(member) {
  const notes = [];
  if (member.hp_valid) notes.push('HP Valid');
  if (member.deposit_valid) notes.push('Deposit Valid');
  if (member.has_response) notes.push('Ada Respon');
  return notes.join(', ') || '-';
}

function showSheetMessage(message, isSuccess) {
  const messageElement = document.getElementById('sheetMessage');
  
  messageElement.textContent = message;
  messageElement.style.display = 'block';
  messageElement.style.background = isSuccess ? '#f0fdf4' : '#fef2f2';
  messageElement.style.border = isSuccess ? '1px solid #bbf7d0' : '1px solid #fecaca';
  messageElement.style.color = isSuccess ? '#166534' : '#dc2626';
  
  setTimeout(() => {
    messageElement.style.display = 'none';
  }, 5000);
}

// ==================== UTILITY FUNCTIONS ====================
function uid() { 
  return 'id' + Math.random().toString(36).slice(2, 9); 
}

function extractOriginalId(fullId) {
  if (!fullId) return '';
  if (fullId.includes('_') && fullId.startsWith('batch_')) {
    const parts = fullId.split('_');
    const originalId = parts.slice(3).join('_');
    return originalId || fullId;
  }
  return fullId;
}

function formatCurrency(amount) {
  return new Intl.NumberFormat('id-ID', {
    style: 'currency',
    currency: 'IDR',
    minimumFractionDigits: 0
  }).format(amount);
}

// ==================== AUTHENTICATION ====================
async function doLogin() {
  const username = document.getElementById('loginUser').value.trim();
  const password = document.getElementById('loginPass').value;

  try {
    const { data: admins, error } = await supabase
      .from('admins')
      .select('*')
      .eq('username', username)
      .eq('password', password);

    if (error) throw error;

    if (admins && admins.length > 0) {
      currentAdmin = admins[0];
      document.getElementById('loginMsg').textContent = 'Login sukses';
      setTimeout(() => openMain(currentAdmin), 500);
    } else {
      document.getElementById('loginMsg').textContent = 'Login gagal. Username/password salah';
    }
  } catch (error) {
    console.error('Login error:', error);
    document.getElementById('loginMsg').textContent = 'Error saat login';
  }
}

function showLogin() {
  document.getElementById('mainUI').style.display = 'none';
  document.getElementById('loginBox').style.display = 'block';
  document.getElementById('signedIn').style.display = 'none';
  document.getElementById('signedOut').style.display = 'block';
}

function logout() {
  currentAdmin = null;
  localStorage.removeItem('currentAdminUser');
  showLogin();
}

function openMain(user) {
  document.getElementById('loginBox').style.display = 'none';
  document.getElementById('mainUI').style.display = 'block';
  document.getElementById('signedIn').style.display = 'flex';
  document.getElementById('signedOut').style.display = 'none';
  document.getElementById('adminName').textContent = user.name;

  localStorage.setItem('currentAdminUser', JSON.stringify(user));
  loadAdminData();
}

// ==================== DATA MANAGEMENT ====================
async function loadAdminData() {
  if (!currentAdmin) return;

  try {
    const { data: members, error: membersError } = await supabase
      .from('members')
      .select('*')
      .eq('admin_username', currentAdmin.username)
      .order('last_deposit', { ascending: false });

    if (membersError) throw membersError;

    const { data: deposits, error: depositsError } = await supabase
      .from('deposits')
      .select('*')
      .eq('admin_username', currentAdmin.username)
      .order('date', { ascending: false });

    if (depositsError) throw depositsError;

    state.members = members || [];
    state.deposits = deposits || [];

    // Simpan original state
    originalState = {
      members: [...state.members],
      deposits: [...state.deposits]
    };

    document.getElementById('fromDate').value = '';
    document.getElementById('toDate').value = '';
    document.getElementById('depositDate').value = '';

    refreshMembers();
    refreshDeposits();
    refreshChart();
    refreshDailySummary();

  } catch (error) {
    console.error('Error loading data:', error);
  }
}

async function refreshMembers() {
  const tb = document.getElementById('memberTable');
  if (!tb) return;

  const keyword = document.getElementById('searchMember')?.value.toLowerCase() || "";
  const statusFilter = document.getElementById('statusFilter')?.value || "";

  const filtered = state.members.filter(m => {
    const originalId = extractOriginalId(m.id);
    const matchKeyword = originalId.toLowerCase().includes(keyword) || 
                        m.name.toLowerCase().includes(keyword) ||
                        m.phone.toLowerCase().includes(keyword);
    const status = getMemberStatus(m.last_deposit);
    const matchStatus = !statusFilter || status === statusFilter;
    return matchKeyword && matchStatus;
  });

  tb.innerHTML = '';

  if (filtered.length === 0) {
    tb.innerHTML = `<tr><td colspan="11" style="text-align:center;padding:20px;color:#666">Tidak ada data member</td></tr>`;
    document.getElementById("memberCount").textContent = `Total data: 0 member`;
    return;
  }

  filtered.forEach(m => {
    const status = getMemberStatus(m.last_deposit);
    const statusClass = status === 'aktif' ? 'aktif' : status === 'normal' ? 'normal' : 'jarang';
    
    const displayDate = formatDateForDisplay(m.last_deposit);
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${extractOriginalId(m.id)}</td>
      <td>${m.name}</td>
      <td>${m.phone}</td>
      <td>${displayDate}</td>
      <td><span class="badge ${statusClass}">${status}</span></td>
      <td style="text-align:center"><input type="checkbox" ${m.hp_valid ? 'checked' : ''} onchange="toggleMemberField('${m.id}', 'hp_valid', this.checked)"></td>
      <td style="text-align:center"><input type="checkbox" ${!m.hp_valid ? 'checked' : ''} onchange="toggleMemberField('${m.id}', 'hp_valid', !this.checked)"></td>
      <td style="text-align:center"><input type="checkbox" ${m.deposit_valid ? 'checked' : ''} onchange="toggleMemberField('${m.id}', 'deposit_valid', this.checked)"></td>
      <td style="text-align:center"><input type="checkbox" ${!m.deposit_valid ? 'checked' : ''} onchange="toggleMemberField('${m.id}', 'deposit_valid', !this.checked)"></td>
      <td style="text-align:center"><input type="checkbox" ${m.has_response ? 'checked' : ''} onchange="toggleMemberField('${m.id}', 'has_response', this.checked)"></td>
      <td style="text-align:center"><input type="checkbox" ${!m.has_response ? 'checked' : ''} onchange="toggleMemberField('${m.id}', 'has_response', !this.checked)"></td>
    `;
    tb.appendChild(tr);
  });

  document.getElementById("memberCount").textContent = `Total data: ${filtered.length} member`;

  const sel = document.getElementById('depositMember');
  sel.innerHTML = '<option value="">-- pilih --</option>';
  state.members.forEach(m => {
    sel.insertAdjacentHTML('beforeend', `<option value="${m.id}">${extractOriginalId(m.id)} - ${m.name}</option>`);
  });
}

async function toggleMemberField(memberId, field, value) {
  try {
    const { error } = await supabase
      .from('members')
      .update({ [field]: value })
      .eq('id', memberId)
      .eq('admin_username', currentAdmin.username);

    if (error) throw error;

    const member = state.members.find(m => m.id === memberId);
    if (member) {
      member[field] = value;
    }
  } catch (error) {
    console.error('Error updating member:', error);
  }
}

// ==================== DEPOSIT MANAGEMENT ====================
async function addDeposit() {
  if (isTimeTravelMode) {
    if (!confirm('Anda sedang dalam mode Time Travel.\n\nDeposit baru akan ditambahkan ke tanggal hari ini, bukan tanggal time travel.\n\nLanjutkan?')) {
      return;
    }
  }

  const memberId = document.getElementById('depositMember').value;
  const manualName = document.getElementById('depositManual').value.trim();
  const amount = getCleanAmount();
  let depositDate = document.getElementById('depositDate').value;

  if (!amount) {
    alert('Nominal wajib diisi');
    return;
  }

  if (!depositDate) {
    depositDate = getCurrentLocalDate();
  }

  let memberName = '';
  let finalMemberId = memberId;

  if (memberId) {
    const member = state.members.find(m => m.id === memberId);
    if (member) {
      memberName = member.name;
    }
  } else if (manualName) {
    memberName = manualName;
    finalMemberId = 'manual_' + uid();
  } else {
    alert('Pilih member atau isi nama manual');
    return;
  }

  try {
    const depositData = {
      id: 'd' + uid(),
      member_id: finalMemberId,
      member_name: memberName,
      amount: amount,
      date: depositDate,
      admin_username: currentAdmin.username,
      created_at: new Date().toISOString()
    };

    const { error } = await supabase
      .from('deposits')
      .insert([depositData]);

    if (error) throw error;

    // Tambahkan ke state asli (bukan state time travel)
    if (isTimeTravelMode) {
      originalState.deposits.push(depositData);
      
      // Update last_deposit member di state asli jika perlu
      if (memberId && !finalMemberId.startsWith('manual_')) {
        const member = originalState.members.find(m => m.id === memberId);
        if (member) {
          const currentLastDeposit = member.last_deposit ? new Date(member.last_deposit) : new Date(0);
          const newDepositDate = new Date(depositDate);
          
          if (newDepositDate > currentLastDeposit) {
            await supabase
              .from('members')
              .update({ last_deposit: depositDate })
              .eq('id', memberId)
              .eq('admin_username', currentAdmin.username);

            member.last_deposit = depositDate;
          }
        }
      }
    } else {
      state.deposits.push(depositData);

      // Update member's last deposit
      if (memberId && !finalMemberId.startsWith('manual_')) {
        const member = state.members.find(m => m.id === memberId);
        if (member) {
          const currentLastDeposit = member.last_deposit ? new Date(member.last_deposit) : new Date(0);
          const newDepositDate = new Date(depositDate);
          
          if (newDepositDate > currentLastDeposit) {
            await supabase
              .from('members')
              .update({ last_deposit: depositDate })
              .eq('id', memberId)
              .eq('admin_username', currentAdmin.username);

            member.last_deposit = depositDate;
          }
        }
      }
    }

    document.getElementById('depositAmount').value = '';
    document.getElementById('depositManual').value = '';
    document.getElementById('depositMember').value = '';
    document.getElementById('depositDate').value = '';

    // Refresh data
    if (isTimeTravelMode) {
      // Tetap di mode time travel, refresh dengan filter yang sama
      filterDataForTimeTravel(currentTravelDate);
    }

    refreshDeposits();
    refreshChart();
    refreshDailySummary();
    refreshMembers();

    alert('Deposit berhasil ditambahkan!');

  } catch (error) {
    console.error('Error adding deposit:', error);
    alert('Error menambahkan deposit');
  }
}

function refreshDeposits() {
  const tb = document.getElementById('depositTable');
  if (!tb) return;

  const keyword = document.getElementById('searchDeposit')?.value.toLowerCase() || "";

  let filteredDeposits = state.deposits;
  
  if (keyword) {
    filteredDeposits = state.deposits.filter(d => {
      const memberName = d.member_id.startsWith('manual_') ? d.member_name : 
                         (state.members.find(m => m.id === d.member_id)?.name || '');
      return memberName.toLowerCase().includes(keyword) || 
             d.amount.toString().includes(keyword) ||
             d.date.includes(keyword);
    });
  }

  tb.innerHTML = '';

  if (filteredDeposits.length === 0) {
    tb.innerHTML = `<tr><td colspan="4" style="text-align:center;padding:20px;color:#666">Belum ada riwayat deposit</td></tr>`;
    return;
  }

  filteredDeposits.forEach(d => {
    const tr = document.createElement('tr');
    const memberDisplay = d.member_id.startsWith('manual_') ? 
      `${d.member_name} (MANUAL)` : 
      `${extractOriginalId(d.member_id)} - ${state.members.find(m => m.id === d.member_id)?.name || '-'}`;
    
    tr.innerHTML = `
      <td>${formatDateForDisplay(d.date)}</td>
      <td>${memberDisplay}</td>
      <td>${formatCurrency(d.amount)}</td>
      <td>
        <button onclick="editDeposit('${d.id}')" style="margin-right:4px">Edit</button>
        <button class="danger" onclick="deleteDeposit('${d.id}')">Hapus</button>
      </td>
    `;
    tb.appendChild(tr);
  });
}

async function editDeposit(depositId) {
  const deposit = state.deposits.find(d => d.id === depositId);
  if (!deposit) return;

  const newAmount = prompt('Masukkan nominal baru:', deposit.amount);
  if (!newAmount) return;

  const cleanAmount = Number(newAmount.replace(/\D/g, ''));

  const newDate = prompt('Masukkan tanggal baru (YYYY-MM-DD) atau biarkan kosong untuk tetap:', deposit.date);
  if (newDate === null) return;

  try {
    const updateData = { amount: cleanAmount };
    if (newDate) {
      updateData.date = newDate;
    }

    const { error } = await supabase
      .from('deposits')
      .update(updateData)
      .eq('id', depositId)
      .eq('admin_username', currentAdmin.username);

    if (error) throw error;

    deposit.amount = cleanAmount;
    if (newDate) {
      deposit.date = newDate;
    }

    // Jika dalam mode time travel, update juga original state
    if (isTimeTravelMode) {
      const originalDeposit = originalState.deposits.find(d => d.id === depositId);
      if (originalDeposit) {
        originalDeposit.amount = cleanAmount;
        if (newDate) {
          originalDeposit.date = newDate;
        }
      }
    }

    refreshDeposits();
    refreshChart();
    refreshDailySummary();

  } catch (error) {
    console.error('Error editing deposit:', error);
    alert('Error mengedit deposit');
  }
}

async function deleteDeposit(depositId) {
  if (!confirm('Hapus deposit ini?')) return;

  try {
    const { error } = await supabase
      .from('deposits')
      .delete()
      .eq('id', depositId)
      .eq('admin_username', currentAdmin.username);

    if (error) throw error;

    state.deposits = state.deposits.filter(d => d.id !== depositId);

    // Jika dalam mode time travel, hapus juga dari original state
    if (isTimeTravelMode) {
      originalState.deposits = originalState.deposits.filter(d => d.id !== depositId);
    }

    refreshDeposits();
    refreshChart();
    refreshDailySummary();

  } catch (error) {
    console.error('Error deleting deposit:', error);
    alert('Error menghapus deposit');
  }
}

// ==================== CHART & DASHBOARD ====================
function refreshChart() {
  const from = document.getElementById('fromDate').value;
  const to = document.getElementById('toDate').value;

  let filteredDeposits = state.deposits;

  if (from || to) {
    filteredDeposits = state.deposits.filter(d => {
      if (from && d.date < from) return false;
      if (to && d.date > to) return false;
      return true;
    });
  }

  updateDateRangeInfo(from, to);

  let grouped = {};
  let labels = [];
  let data = [];

  if (currentView === 'daily') {
    filteredDeposits.forEach(d => {
      grouped[d.date] = (grouped[d.date] || 0) + d.amount;
    });
    labels = Object.keys(grouped).sort();
    data = labels.map(date => grouped[date]);
  } else if (currentView === 'weekly') {
    filteredDeposits.forEach(d => {
      const date = new Date(d.date);
      const weekStart = new Date(date);
      weekStart.setDate(date.getDate() - date.getDay());
      const weekKey = weekStart.toISOString().slice(0, 10);
      grouped[weekKey] = (grouped[weekKey] || 0) + d.amount;
    });
    labels = Object.keys(grouped).sort();
    data = labels.map(week => grouped[week]);
    labels = labels.map(week => `Minggu ${formatDateForDisplay(week)}`);
  } else if (currentView === 'monthly') {
    filteredDeposits.forEach(d => {
      const monthKey = d.date.slice(0, 7);
      grouped[monthKey] = (grouped[monthKey] || 0) + d.amount;
    });
    labels = Object.keys(grouped).sort();
    data = labels.map(month => grouped[month]);
    labels = labels.map(month => {
      const [year, monthNum] = month.split('-');
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
      return `${monthNames[parseInt(monthNum) - 1]} ${year}`;
    });
  }

  const ctx = document.getElementById('omsetChart').getContext('2d');
  
  if (chartInstance) {
    chartInstance.destroy();
  }

  if (labels.length === 0) {
    chartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Tidak ada data'],
        datasets: [{
          label: 'Omset',
          data: [0],
          borderColor: '#d1d5db',
          backgroundColor: 'rgba(209, 213, 219, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: false }
        }
      }
    });
  } else {
    chartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Omset',
          data: data,
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `Rp ${context.raw.toLocaleString('id-ID')}`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return 'Rp ' + value.toLocaleString('id-ID');
              }
            }
          }
        }
      }
    });
  }

  refreshDailySummary();
}

function updateDateRangeInfo(from, to) {
  const infoElement = document.getElementById('dateRangeInfo');
  
  if (isTimeTravelMode) {
    infoElement.textContent = `üïí Mode Time Travel: Menampilkan data hingga ${formatDateForDisplay(currentTravelDate)} (${state.deposits.length} transaksi) - Tampilan ${currentView === 'daily' ? 'Harian' : currentView === 'weekly' ? 'Mingguan' : 'Bulanan'}`;
    infoElement.style.background = '#fef3c7';
    infoElement.style.borderColor = '#fcd34d';
    infoElement.style.color = '#92400e';
  } else if (!from && !to) {
    infoElement.textContent = `Menampilkan semua data historis (${state.deposits.length} transaksi) - Tampilan ${currentView === 'daily' ? 'Harian' : currentView === 'weekly' ? 'Mingguan' : 'Bulanan'}`;
    infoElement.style.background = '#f0f9ff';
    infoElement.style.borderColor = '#bae6fd';
    infoElement.style.color = '#0369a1';
  } else if (from && to) {
    const filteredCount = state.deposits.filter(d => d.date >= from && d.date <= to).length;
    infoElement.textContent = `Menampilkan data dari ${formatDateForDisplay(from)} hingga ${formatDateForDisplay(to)} (${filteredCount} transaksi) - Tampilan ${currentView === 'daily' ? 'Harian' : currentView === 'weekly' ? 'Mingguan' : 'Bulanan'}`;
    infoElement.style.background = '#fef3c7';
    infoElement.style.borderColor = '#fcd34d';
    infoElement.style.color = '#92400e';
  } else if (from) {
    const filteredCount = state.deposits.filter(d => d.date >= from).length;
    infoElement.textContent = `Menampilkan data sejak ${formatDateForDisplay(from)} (${filteredCount} transaksi) - Tampilan ${currentView === 'daily' ? 'Harian' : currentView === 'weekly' ? 'Mingguan' : 'Bulanan'}`;
    infoElement.style.background = '#fef3c7';
    infoElement.style.borderColor = '#fcd34d';
    infoElement.style.color = '#92400e';
  } else if (to) {
    const filteredCount = state.deposits.filter(d => d.date <= to).length;
    infoElement.textContent = `Menampilkan data hingga ${formatDateForDisplay(to)} (${filteredCount} transaksi) - Tampilan ${currentView === 'daily' ? 'Harian' : currentView === 'weekly' ? 'Mingguan' : 'Bulanan'}`;
    infoElement.style.background = '#fef3c7';
    infoElement.style.borderColor = '#fcd34d';
    infoElement.style.color = '#92400e';
  }
}

function refreshDailySummary() {
  const from = document.getElementById('fromDate').value;
  const to = document.getElementById('toDate').value;
  
  let filteredDeposits = state.deposits;
  let summaryText = 'Semua Waktu';
  let depositLabel = 'Total Jumlah Deposit';
  let memberLabel = 'Total Member Deposit';
  let memberDesc = 'Melakukan deposit';

  if (isTimeTravelMode) {
    summaryText = `Time Travel: Hingga ${formatDateForDisplay(currentTravelDate)}`;
    depositLabel = 'Total Deposit hingga Tanggal';
    memberLabel = 'Member Deposit hingga Tanggal';
    memberDesc = 'Melakukan deposit hingga tanggal tersebut';
  } else if (from || to) {
    filteredDeposits = state.deposits.filter(d => {
      if (from && d.date < from) return false;
      if (to && d.date > to) return false;
      return true;
    });
    
    if (from && to) {
      summaryText = `Periode ${formatDateForDisplay(from)} - ${formatDateForDisplay(to)}`;
      depositLabel = 'Total Deposit Periode';
      memberLabel = 'Member Deposit Periode';
      memberDesc = 'Melakukan deposit pada periode ini';
    } else if (from) {
      summaryText = `Sejak ${formatDateForDisplay(from)}`;
      depositLabel = 'Total Deposit Sejak';
      memberLabel = 'Member Deposit Sejak';
      memberDesc = 'Melakukan deposit sejak tanggal tersebut';
    } else if (to) {
      summaryText = `Hingga ${formatDateForDisplay(to)}`;
      depositLabel = 'Total Deposit Hingga';
      memberLabel = 'Member Deposit Hingga';
      memberDesc = 'Melakukan deposit hingga tanggal tersebut';
    }
  }

  const totalDeposit = filteredDeposits.reduce((sum, d) => sum + d.amount, 0);
  const uniqueMembers = new Set(filteredDeposits.map(d => d.member_id)).size;

  document.getElementById('totalDepositToday').textContent = formatCurrency(totalDeposit);
  document.getElementById('totalMemberToday').textContent = uniqueMembers + ' Member';
  document.getElementById('summaryDate').textContent = summaryText;
  document.getElementById('totalDepositLabel').textContent = depositLabel;
  document.getElementById('totalMemberLabel').textContent = memberLabel;
  document.getElementById('memberDepositDesc').textContent = memberDesc;
}

// ==================== HISTORICAL DATA FUNCTIONS ====================
function showAllHistoricalData() {
  document.getElementById('fromDate').value = '';
  document.getElementById('toDate').value = '';
  
  if (isTimeTravelMode) {
    exitTimeTravel();
  } else {
    refreshChart();
    refreshMembers();
    refreshDeposits();
  }
}

function searchDepositByDate() {
  const specificDate = prompt('Masukkan tanggal yang ingin dilihat (YYYY-MM-DD):');
  if (specificDate) {
    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
    if (!dateRegex.test(specificDate)) {
      alert('Format tanggal tidak valid. Gunakan format YYYY-MM-DD');
      return;
    }
    
    document.getElementById('fromDate').value = specificDate;
    document.getElementById('toDate').value = specificDate;
    refreshChart();
    refreshDeposits();
  }
}

function showMonthlyView() {
  currentView = 'monthly';
  refreshChart();
}

function showWeeklyView() {
  currentView = 'weekly';
  refreshChart();
}

function showDailyView() {
  currentView = 'daily';
  refreshChart();
}

function resetFilter() {
  document.getElementById('fromDate').value = '';
  document.getElementById('toDate').value = '';
  refreshChart();
}

// ==================== IMPORT/EXPORT ====================
async function importFromMaster() {
  alert('Fitur import dari Master akan tersedia setelah setup Master selesai');
}

async function resetAdminData() {
  if (!confirm('HAPUS SEMUA DATA ADMIN?\\n\\nTindakan ini akan menghapus SEMUA data member dan deposit.\\nTindakan ini tidak dapat dibatalkan!')) return;

  try {
    const { error: depositError } = await supabase
      .from('deposits')
      .delete()
      .eq('admin_username', currentAdmin.username);

    if (depositError) throw depositError;

    const { error: memberError } = await supabase
      .from('members')
      .delete()
      .eq('admin_username', currentAdmin.username);

    if (memberError) throw memberError;

    state.members = [];
    state.deposits = [];
    originalState.members = [];
    originalState.deposits = [];

    if (isTimeTravelMode) {
      exitTimeTravel();
    }

    refreshMembers();
    refreshDeposits();
    refreshChart();
    refreshDailySummary();

    alert('Data admin berhasil direset');

  } catch (error) {
    console.error('Error resetting data:', error);
    alert('Error reset data');
  }
}

// ==================== FORMATTING ====================
const inputAmt = document.getElementById('depositAmount');
if (inputAmt) {
  inputAmt.addEventListener('input', function(e) {
    let value = this.value.replace(/\D/g, '');
    if (!value) { 
      this.value = ''; 
      return; 
    }
    this.value = new Intl.NumberFormat('id-ID').format(value);
  });
}

function getCleanAmount() {
  let raw = document.getElementById('depositAmount').value;
  return Number(raw.replace(/\./g, ''));
}

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('fromDate').value = '';
  document.getElementById('toDate').value = '';

  const savedUser = localStorage.getItem('currentAdminUser');
  if (savedUser) {
    try {
      currentAdmin = JSON.parse(savedUser);
      openMain(currentAdmin);
    } catch (e) {
      localStorage.removeItem('currentAdminUser');
    }
  }
});
</script>
</body>
</html>
