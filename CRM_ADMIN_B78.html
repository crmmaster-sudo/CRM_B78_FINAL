<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CRM ADMIN</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#f3f8ff; --card:#fff; --accent:#3b82f6; --muted:#666;
    --success:#16a34a; --danger:#ef4444; --warning:#f59e0b;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,sans-serif}
  body{margin:0;background:var(--bg);color:#1b1b1b}
  header{padding:16px 24px;display:flex;align-items:center;justify-content:space-between;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.05)}
  .app{max-width:1200px;margin:20px auto;padding:20px}
  .card{background:var(--card);border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,.06);margin-bottom:20px}
  input,select{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-top:6px;font-size:14px}
  
  /* ==================== ANIMASI TOMBOL ==================== */
  button{
    padding:10px 16px;
    border-radius:8px;
    border:0;
    background:var(--accent);
    color:#fff;
    cursor:pointer;
    font-size:14px;
    font-weight:500;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
  }
  
  button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
  }
  
  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  button:hover::before {
    left: 100%;
  }
  
  button:active {
    transform: translateY(0);
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    transition: all 0.1s ease;
  }
  
  button:focus {
    outline: 2px solid rgba(59, 130, 246, 0.5);
    outline-offset: 2px;
  }
  
  /* Tombol dengan warna khusus */
  button.danger{
    background:var(--danger);
  }
  button.success{
    background:var(--success);
  }
  button.warning{
    background:var(--warning);
  }
  button.info{
    background:#6b7280;
  }
  
  /* Animasi khusus untuk tombol success */
  button.success:hover {
    background: #15803d;
  }
  
  /* Animasi khusus untuk tombol danger */
  button.danger:hover {
    background: #dc2626;
  }
  
  /* Animasi khusus untuk tombol warning */
  button.warning:hover {
    background: #d97706;
  }
  
  /* Animasi khusus untuk tombol info */
  button.info:hover {
    background: #4b5563;
  }
  
  /* Tombol dengan icon besar */
  button.large-icon {
    padding: 12px 20px;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  
  /* Tombol loading state */
  button.loading {
    position: relative;
    color: transparent;
  }
  
  button.loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    top: 50%;
    left: 50%;
    margin-left: -8px;
    margin-top: -8px;
    border: 2px solid transparent;
    border-top: 2px solid #ffffff;
    border-radius: 50%;
    animation: button-spinner 0.8s linear infinite;
  }
  
  @keyframes button-spinner {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Tombol dengan pulse animation untuk aksi penting */
  button.pulse {
    animation: pulse-animation 2s infinite;
  }
  
  @keyframes pulse-animation {
    0% {
      box-shadow: 0 0 0 0px rgba(59, 130, 246, 0.4);
    }
    70% {
      box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
    }
    100% {
      box-shadow: 0 0 0 0px rgba(59, 130, 246, 0);
    }
  }
  
  /* Tombol di header */
  header button {
    background: #f8fafc;
    color: #374151;
    border: 1px solid #e5e7eb;
  }
  
  header button:hover {
    background: #f1f5f9;
    color: #1f2937;
  }
  
  /* Tombol date navigation */
  .nav-btn {
    padding: 6px;
    background: transparent;
    color: #64748b;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .nav-btn:hover {
    background: #e2e8f0;
    transform: scale(1.05);
  }
  
  .today-btn {
    padding: 6px 10px;
    background: #3b82f6;
    color: white;
    border-radius: 6px;
    font-size: 12px;
    border: none;
    transition: all 0.2s ease;
  }
  
  .today-btn:hover {
    background: #2563eb;
    transform: translateY(-1px);
  }

  .cols{display:grid;grid-template-columns:1fr 380px;gap:20px;margin-top:20px}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:12px 8px;border-bottom:1px solid #eee;text-align:left;vertical-align:middle}
  .badge{padding:4px 8px;border-radius:6px;font-size:11px;font-weight:600}
  .aktif{background:#dcfce7;color:#166534}
  .normal{background:#fef9c3;color:#854d0e}
  .jarang{background:#fee2e2;color:#991b1b}
  .filter-bar{display:flex;gap:8px;flex-wrap:wrap;margin:16px 0;align-items:center}
  .search-bar{display:flex;gap:8px;margin-bottom:16px;align-items:center}
  .summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:20px}
  .summary-card{text-align:center;background:#f9fafb;box-shadow:none;padding:20px}
  .summary-value{font-size:24px;font-weight:700;margin:8px 0}
  .summary-label{font-size:14px;color:#666;margin-bottom:4px}
  .chart-container{margin:20px 0;min-height:200px}
  input[type="checkbox"]{transform:scale(1.2);margin:0 4px}
  th{background:#f8fafc;font-weight:600;font-size:13px}
  .sheet-message{display:none; padding:12px; border-radius:8px; font-size:13px; text-align:center; margin-top:12px}
  .sheet-info{background:#eff6ff;border:1px solid #dbeafe;color:#1e40af;padding:12px;border-radius:8px;margin-bottom:16px;font-size:13px}
  .form-group{margin-bottom:16px}
  .form-label{font-weight:500;display:block;margin-bottom:6px;color:#374151}
  .manual-process{background:#fff7ed;border:1px solid #fdba74;color:#9a3412;padding:16px;border-radius:8px;margin:16px 0;font-size:14px;line-height:1.6}
  .manual-steps{background:#fffbeb;padding:12px;border-radius:6px;margin:12px 0}
  .date-info{background:#f0f9ff;border:1px solid #bae6fd;color:#0369a1;padding:8px 12px;border-radius:6px;font-size:12px;margin:8px 0}
  .chart-actions{display:flex;gap:8px;margin:10px 0;justify-content:center}
  .reset-section{background:#fef2f2;border:1px solid #fecaca;padding:16px;border-radius:8px;margin:16px 0}
  .reset-buttons{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .date-navigation{display:flex;align-items:center;gap:8px;background:#f8fafc;padding:6px 12px;border-radius:8px;border:1px solid #e2e8f0}
  .date-display{font-size:13px;font-weight:500;color:#475569;min-width:140px;text-align:center}
  .empty-state{padding:40px;text-align:center;color:#666;background:#f9fafb}
  .empty-state-icon{font-size:24px;margin-bottom:8px}
  .empty-state-title{font-size:16px;margin-bottom:8px;font-weight:600}
  .empty-state-desc{font-size:14px;margin-bottom:4px}
  .empty-state-hint{font-size:12px;color:#9ca3af}
  .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center}
  .modal-content{background:white;padding:24px;border-radius:12px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto}
</style>
</head>
<body>
<header>
  <div style="font-weight:700;font-size:18px">CRM ADMIN</div>
  <div id="signedOut"><button onclick="showLogin()">Login</button></div>
  <div id="signedIn" style="display:none;align-items:center;gap:12px">
    <div id="adminName"></div>
    
    <!-- Date Navigation -->
    <div class="date-navigation">
      <button class="nav-btn" onclick="goToPreviousDay()">◀</button>
      <div id="currentDateDisplay" class="date-display">-</div>
      <button class="nav-btn" onclick="goToNextDay()">▶</button>
      <button class="today-btn" onclick="goToToday()">Hari Ini</button>
    </div>
    
    <button onclick="logout()">Logout</button>
  </div>
</header>

<div class="app">
  <!-- LOGIN -->
  <div id="loginBox" class="card" style="max-width:400px;margin:80px auto">
    <h2 style="text-align:center;margin-bottom:20px">Login Admin</h2>
    <input id="loginUser" placeholder="Username" style="margin-bottom:12px"/>
    <input id="loginPass" type="password" placeholder="Password" style="margin-bottom:16px"/>
    <button onclick="doLogin()" style="width:100%;padding:12px" id="loginButton">Masuk</button>
    <div id="loginMsg" style="color:red;margin-top:12px;text-align:center"></div>
  </div>

  <!-- MAIN -->
  <div id="mainUI" style="display:none">
    <!-- Dashboard Pendapatan -->
    <div class="card">
      <h3 style="margin-bottom:16px">Dashboard Pendapatan</h3>
      
      <div class="filter-bar">
        <input type="date" id="fromDate" style="width:150px"/>
        <input type="date" id="toDate" style="width:150px"/>
        <button onclick="refreshChart()">Terapkan Filter</button>
        <button onclick="showAllHistoricalData()" class="info">Lihat Semua Data</button>
        <button onclick="searchDepositByDate()" class="warning">Cari Tanggal</button>
        <button onclick="importFromMaster()" class="pulse">Terima dari Master</button>
      </div>

      <div class="date-info" id="dateRangeInfo">
        Menampilkan semua data historis
      </div>

      <div class="chart-container">
        <canvas id="omsetChart" height="150"></canvas>
      </div>

      <div class="chart-actions">
        <button onclick="showMonthlyView()" class="info">Tampilan Bulanan</button>
        <button onclick="showWeeklyView()" class="info">Tampilan Mingguan</button>
        <button onclick="showDailyView()" class="info">Tampilan Harian</button>
      </div>
      
      <div class="summary-grid">
        <div class="card summary-card">
          <div class="summary-label" id="totalDepositLabel">Total Jumlah Deposit</div>
          <div id="totalDepositToday" class="summary-value" style="color:#3b82f6;">Rp 0</div>
          <small id="summaryDate" style="color:#666;">Semua waktu</small>
        </div>
        <div class="card summary-card">
          <div class="summary-label" id="totalMemberLabel">Total Member Deposit</div>
          <div id="totalMemberToday" class="summary-value" style="color:#16a34a;">0 Member</div>
          <small style="color:#666;" id="memberDepositDesc">Melakukan deposit</small>
        </div>
      </div>

      <!-- RESET DATA SECTION -->
      <div class="reset-section">
        <h4 style="margin:0 0 12px 0;color:#dc2626">⚠️ Reset Data Admin</h4>
        <p style="margin:0 0 12px 0;font-size:14px;color:#7f1d1d">
          Hati-hati! Tindakan reset data tidak dapat dibatalkan. Pilih opsi reset sesuai kebutuhan:
        </p>
        <div class="reset-buttons">
          <button class="danger" onclick="showResetMemberModal()" style="background:#dc2626">👥 Reset Member per Tanggal</button>
          <button class="danger" onclick="resetAdminData()" style="background:#7f1d1d">💥 Reset Semua Data</button>
        </div>
        <small style="color:#7f1d1d;display:block;margin-top:8px">
          • Reset Member per Tanggal: Hanya hapus data MEMBER pada tanggal tertentu (deposit tetap)<br>
          • Reset Semua: Hapus SEMUA data admin (semua member + semua deposit)
        </small>
      </div>
    </div>

    <div class="cols">
      <!-- Database Member -->
      <div class="card">
        <h3 style="margin-bottom:16px">Database Member</h3>
        <p id="memberCount" style="font-weight:600;color:#555;margin-bottom:16px">Total data: 0 member</p>
        
        <div class="search-bar">
          <input id="searchMember" placeholder="Cari ID/Nama..." oninput="refreshMembers()" 
                 style="padding:10px 12px;width:250px;border:1px solid #ddd;border-radius:8px">
          <select id="statusFilter" onchange="refreshMembers()" 
                  style="padding:10px 12px;width:150px;border:1px solid #ddd;border-radius:8px">
            <option value="">Semua Status</option>
            <option value="aktif">Aktif</option>
            <option value="normal">Normal</option>
            <option value="jarang">Jarang</option>
          </select>
          <button onclick="refreshMembers()" class="info">Refresh</button>
        </div>

        <div style="overflow-x:auto; border:1px solid #eee; border-radius:8px;">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Nama</th>
                <th>HP</th>
                <th>Last Deposit</th>
                <th>Status</th>
                <th>HP Valid</th>
                <th>No HP Tidak Valid</th>
                <th>Sudah Deposit</th>
                <th>Belum Deposit</th>
                <th>Ada Respon</th>
                <th>Tidak Respon</th>
              </tr>
            </thead>
            <tbody id="memberTable"></tbody>
          </table>
        </div>
      </div>

      <!-- Right Column -->
      <div>
        <!-- Manual Google Drive Process -->
        <div class="card">
          <h3 style="margin-bottom:16px">📁 Simpan ke Google Drive</h3>
          
          <div class="manual-process">
            <strong>Proses Manual Sederhana:</strong>
            <div class="manual-steps">
              1️⃣ <strong>Download File Excel</strong> (tombol di bawah)<br>
              2️⃣ <strong>Buka drive.google.com</strong><br>
              3️⃣ <strong>Upload file Excel</strong> yang sudah didownload<br>
              4️⃣ <strong>Selesai!</strong> File sudah ada di Google Drive
            </div>
          </div>
          
          <div style="margin:16px 0; text-align:center">
            <button onclick="downloadForGoogleDrive()" class="success large-icon" style="padding:12px 24px; font-size:16px">
              📥 Download untuk Google Drive
            </button>
          </div>
          
          <div style="color:#666; font-size:13px; line-height:1.5; text-align:center">
            <strong>Keuntungan:</strong><br>
            • File tersimpan dengan format tanggal<br>
            • Kontrol penuh atas file di Google Drive<br>
            • Bisa pilih folder sendiri<br>
            • Bisa rename file sesuai kebutuhan
          </div>
          
          <div id="sheetMessage" class="sheet-message"></div>
        </div>

        <!-- Tambah Deposit -->
        <div class="card">
          <h3 style="margin-bottom:16px">Tambah Deposit</h3>
          
          <div class="form-group">
            <label class="form-label">Pilih Member</label>
            <select id="depositMember" style="padding:10px">
              <option value="">-- pilih --</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Atau Nama Manual</label>
            <input id="depositManual" placeholder="Nama luar database" style="padding:10px"/>
          </div>
          
          <div class="form-group">
            <label class="form-label">Nominal</label>
            <input id="depositAmount" type="text" placeholder="100000" style="padding:10px"/>
          </div>

          <div class="form-group">
            <label class="form-label">Tanggal Deposit</label>
            <input type="date" id="depositDate" style="padding:10px"/>
            <small style="color:#666;">Kosongkan untuk tanggal hari ini</small>
          </div>
          
          <button onclick="addDeposit()" style="width:100%;padding:12px" id="addDepositButton">Tambah Deposit</button>
        </div>

        <!-- Riwayat Deposit -->
        <div class="card">
          <h4 style="margin-bottom:16px">Riwayat Deposit</h4>
          <div class="search-bar">
            <input id="searchDeposit" placeholder="Cari nama/nominal..." oninput="refreshDeposits()" 
                   style="padding:8px 12px;width:200px;border:1px solid #ddd;border-radius:8px">
            <button onclick="refreshDeposits()" class="info">Refresh</button>
          </div>
          <div style="overflow-x:auto; border:1px solid #eee; border-radius:8px;">
            <table>
              <thead>
                <tr>
                  <th>Tgl</th>
                  <th>Member</th>
                  <th>Jumlah</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody id="depositTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Reset Member -->
<div id="resetMemberModal" class="modal">
  <div class="modal-content">
    <h3 style="color:#dc2626; margin-bottom:16px;">👥 Reset Member per Tanggal</h3>
    
    <div class="form-group">
      <label class="form-label">Tanggal yang akan direset (YYYY-MM-DD)</label>
      <input type="date" id="resetDateInput" style="padding:10px; border:1px solid #e5e7eb; border-radius:8px"/>
      <small style="color:#666;">Pilih tanggal data member yang ingin dihapus</small>
    </div>

    <div id="resetPreview" style="display:none; background:#f8fafc; padding:12px; border-radius:8px; margin:12px 0;">
      <h4 style="margin:0 0 8px 0;">Preview Data yang Akan Dihapus:</h4>
      <div id="resetPreviewContent"></div>
    </div>

    <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:20px;">
      <button onclick="closeResetModal()" style="padding:8px 16px; border:1px solid #d1d5db; background:white; border-radius:6px; cursor:pointer;">
        Batal
      </button>
      <button onclick="confirmResetMember()" id="confirmResetBtn" style="padding:8px 16px; background:#dc2626; color:white; border:none; border-radius:6px; cursor:pointer; display:none;">
        Hapus Data Member
      </button>
      <button onclick="previewResetData()" style="padding:8px 16px; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer;">
        Preview Data
      </button>
    </div>
  </div>
</div>

<script>
// ==================== KONFIGURASI SUPA BASE ====================
const SUPABASE_URL = 'https://qclwmenzzzgzrrjuznql.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjbHdtZW56enpnenJyanV6bnFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNzM5MTgsImV4cCI6MjA3NTk0OTkxOH0.Gye11m1kIvDqaKBdKWHFpX17vTdlQrRE5bODf8fwPW0';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let currentAdmin = null;
let currentResetDate = null;
let previewMembers = [];

// ==================== FUNGSI ANIMASI TOMBOL ====================
function addButtonAnimation(button, type = 'normal') {
  if (!button) return;
  
  button.addEventListener('click', function(e) {
    // Efek ripple
    const ripple = document.createElement('span');
    const rect = button.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    const x = e.clientX - rect.left - size / 2;
    const y = e.clientY - rect.top - size / 2;
    
    ripple.style.cssText = `
      position: absolute;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.6);
      transform: scale(0);
      animation: ripple-animation 0.6s linear;
      pointer-events: none;
      width: ${size}px;
      height: ${size}px;
      left: ${x}px;
      top: ${y}px;
    `;
    
    button.style.position = 'relative';
    button.style.overflow = 'hidden';
    button.appendChild(ripple);
    
    setTimeout(() => {
      if (ripple.parentNode) {
        ripple.parentNode.removeChild(ripple);
      }
    }, 600);
  });
}

// Style untuk efek ripple
const rippleStyle = document.createElement('style');
rippleStyle.textContent = `
  @keyframes ripple-animation {
    to {
      transform: scale(4);
      opacity: 0;
    }
  }
`;
document.head.appendChild(rippleStyle);

// Inisialisasi animasi untuk tombol penting
function initializeButtonAnimations() {
  // Tombol login
  const loginButton = document.getElementById('loginButton');
  addButtonAnimation(loginButton);
  
  // Tombol tambah deposit
  const addDepositButton = document.getElementById('addDepositButton');
  addButtonAnimation(addDepositButton);
  
  // Tombol download Google Drive
  const downloadButtons = document.querySelectorAll('button.success.large-icon');
  downloadButtons.forEach(button => addButtonAnimation(button, 'success'));
  
  // Tombol reset danger
  const resetButtons = document.querySelectorAll('button.danger');
  resetButtons.forEach(button => addButtonAnimation(button, 'danger'));
  
  // Semua tombol lainnya
  const allButtons = document.querySelectorAll('button');
  allButtons.forEach(button => {
    if (!button.hasAttribute('data-animated')) {
      addButtonAnimation(button);
      button.setAttribute('data-animated', 'true');
    }
  });
}

// Fungsi untuk menampilkan loading state pada tombol
function setButtonLoading(button, isLoading) {
  if (isLoading) {
    button.classList.add('loading');
    button.disabled = true;
  } else {
    button.classList.remove('loading');
    button.disabled = false;
  }
}

// ==================== MODAL FUNCTIONS ====================
function showResetMemberModal() {
  document.getElementById('resetMemberModal').style.display = 'flex';
  document.getElementById('resetDateInput').value = '';
  document.getElementById('resetPreview').style.display = 'none';
  document.getElementById('confirmResetBtn').style.display = 'none';
  document.getElementById('resetPreviewContent').innerHTML = '';
}

function closeResetModal() {
  document.getElementById('resetMemberModal').style.display = 'none';
}

function previewResetData() {
  const resetDate = document.getElementById('resetDateInput').value;
  
  if (!resetDate) {
    alert('Silakan pilih tanggal terlebih dahulu');
    return;
  }

  // Validasi format tanggal
  const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
  if (!dateRegex.test(resetDate)) {
    alert('Format tanggal tidak valid. Gunakan format YYYY-MM-DD');
    return;
  }

  // Validasi tanggal tidak di masa depan
  const today = getCurrentLocalDate();
  if (resetDate > today) {
    alert('Tidak bisa reset data untuk tanggal masa depan');
    return;
  }

  currentResetDate = resetDate;
  showNotification('🔍 Mencari data member...');

  // Cari member yang dibuat pada tanggal tersebut
  previewMembers = state.members.filter(member => {
    const memberDate = member.created_at ? member.created_at.split('T')[0] : '';
    return memberDate === resetDate;
  });

  const previewContent = document.getElementById('resetPreviewContent');
  const previewSection = document.getElementById('resetPreview');
  const confirmBtn = document.getElementById('confirmResetBtn');

  if (previewMembers.length === 0) {
    previewContent.innerHTML = `
      <div style="text-align:center; padding:20px; color:#666;">
        <div style="font-size:24px; margin-bottom:8px;">📭</div>
        <div style="font-weight:600; margin-bottom:4px;">Tidak Ada Data</div>
        <div>Tidak ditemukan data member untuk tanggal ${formatDateForDisplay(resetDate)}</div>
      </div>
    `;
    confirmBtn.style.display = 'none';
  } else {
    previewContent.innerHTML = `
      <div style="margin-bottom:12px;">
        <strong>Tanggal:</strong> ${formatDateForDisplay(resetDate)}<br>
        <strong>Jumlah Member:</strong> ${previewMembers.length} data<br>
        <strong>Contoh Data:</strong>
      </div>
      <div style="max-height:120px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:6px; padding:8px; background:white;">
        ${previewMembers.slice(0, 10).map(member => `
          <div style="padding:4px 0; border-bottom:1px solid #f3f4f6;">
            <span style="font-family:monospace; font-size:12px;">${extractOriginalId(member.id)}</span> - ${member.name}
          </div>
        `).join('')}
        ${previewMembers.length > 10 ? `<div style="padding:4px 0; color:#666; font-style:italic;">... dan ${previewMembers.length - 10} data lainnya</div>` : ''}
      </div>
      <div style="margin-top:8px; padding:8px; background:#fef2f2; border-radius:4px; border-left:4px solid #dc2626;">
        <small style="color:#dc2626;">
          ⚠️ Data yang dihapus tidak dapat dikembalikan. Pastikan Anda sudah backup data jika diperlukan.
        </small>
      </div>
    `;
    confirmBtn.style.display = 'block';
  }

  previewSection.style.display = 'block';
}

// ==================== FUNGSI RESET DATA YANG DIPERBAIKI ====================
async function confirmResetMember() {
  if (!currentResetDate || previewMembers.length === 0) {
    alert('Tidak ada data yang akan direset');
    return;
  }

  const finalConfirm = confirm(
    `⚠️ KONFIRMASI HAPUS DATA MEMBER\n\n` +
    `Tanggal: ${formatDateForDisplay(currentResetDate)}\n` +
    `Jumlah Data: ${previewMembers.length} member\n\n` +
    `Data deposit TIDAK AKAN DIHAPUS dan tetap aman!\n` +
    `Tindakan ini tidak dapat dibatalkan!\n\n` +
    `Lanjutkan menghapus?`
  );

  if (!finalConfirm) return;

  try {
    showNotification('🔄 Memproses reset data member...');

    // Hapus member dari database
    const { error: deleteError } = await supabase
      .from('members')
      .delete()
      .eq('admin_username', currentAdmin.username)
      .gte('created_at', currentResetDate + 'T00:00:00.000Z')
      .lte('created_at', currentResetDate + 'T23:59:59.999Z');

    if (deleteError) throw deleteError;

    // Update state lokal
    state.members = state.members.filter(member => {
      const memberDate = member.created_at ? member.created_at.split('T')[0] : '';
      return memberDate !== currentResetDate;
    });

    // Refresh UI
    refreshMembers();
    closeResetModal();

    showNotification(`✅ Reset berhasil! ${previewMembers.length} member pada ${formatDateForDisplay(currentResetDate)} telah dihapus`);

    // Tawarkan untuk import data baru dari master
    setTimeout(() => {
      if (confirm(`✅ Reset selesai!\n\n${previewMembers.length} data member pada ${formatDateForDisplay(currentResetDate)} telah dihapus.\n\nSekarang Anda bisa menerima data baru dari Master Admin.\n\nLanjutkan import data dari Master?`)) {
        importFromMaster();
      }
    }, 1000);

  } catch (error) {
    console.error('Error resetting member data by date:', error);
    alert('❌ Error reset data member: ' + error.message);
    showNotification('❌ Gagal reset data member');
  }
}

async function resetAdminData() {
  if (!confirm(`💥 HAPUS SEMUA DATA ADMIN?\n\nTindakan ini akan menghapus SEMUA DATA (semua member + semua deposit) admin ${currentAdmin.username}.\nTindakan ini tidak dapat dibatalkan!`)) return;

  try {
    showNotification('🔄 Menghapus semua data...');

    const { error: depositError } = await supabase
      .from('deposits')
      .delete()
      .eq('admin_username', currentAdmin.username);

    if (depositError) throw depositError;

    const { error: memberError } = await supabase
      .from('members')
      .delete()
      .eq('admin_username', currentAdmin.username);

    if (memberError) throw memberError;

    // Reset state
    state.members = [];
    state.deposits = [];
    dateWiseData = {};
    
    // Refresh UI
    refreshMembers();
    refreshDeposits();
    refreshChart();
    refreshDailySummary();

    showNotification('💥 Semua data admin berhasil direset!');
    alert('✅ Semua data admin berhasil direset! Sistem sekarang bersih.');

  } catch (error) {
    console.error('Error resetting data:', error);
    alert('❌ Error reset data: ' + error.message);
    showNotification('❌ Gagal reset data');
  }
}

// ==================== IMPOR DARI MASTER YANG DIPERBAIKI ====================
async function importFromMaster() {
  const currentDate = getCurrentViewDate();
  
  const confirmImport = confirm(
    `📥 IMPORT DATA DARI MASTER ADMIN\n\n` +
    `Tanggal: ${formatDateForDisplay(currentDate)}\n\n` +
    `Data member dari master akan ditambahkan ke database.\n\n` +
    `Pastikan Master Admin sudah mengirim data terbaru.`
  );
  
  if (!confirmImport) return;

  try {
    showNotification('🔄 Memproses import data dari Master...');

    // SIMULASI DATA DARI MASTER (nanti diganti dengan API call sebenarnya)
    const masterData = {
      members: [
        {
          id: `batch_${currentDate}_${uid()}_M001`,
          name: "Member Baru 1",
          phone: "081234567890",
          last_deposit: null,
          hp_valid: false,
          deposit_valid: false,
          has_response: false,
          admin_username: currentAdmin.username,
          created_at: new Date().toISOString()
        },
        {
          id: `batch_${currentDate}_${uid()}_M002`,
          name: "Member Baru 2", 
          phone: "081234567891",
          last_deposit: null,
          hp_valid: false,
          deposit_valid: false,
          has_response: false,
          admin_username: currentAdmin.username,
          created_at: new Date().toISOString()
        },
        {
          id: `batch_${currentDate}_${uid()}_M003`,
          name: "Member Baru 3",
          phone: "081234567892",
          last_deposit: null,
          hp_valid: false,
          deposit_valid: false,
          has_response: false,
          admin_username: currentAdmin.username,
          created_at: new Date().toISOString()
        }
      ]
    };

    // Insert data ke database
    const { error: insertError } = await supabase
      .from('members')
      .insert(masterData.members);

    if (insertError) {
      if (insertError.code === '23505') { // Duplicate key error
        throw new Error('Beberapa data sudah ada di database. Pastikan data dari Master adalah data baru.');
      }
      throw insertError;
    }

    // Update state lokal
    state.members.push(...masterData.members);
    
    // Update dateWiseData
    if (!dateWiseData[currentDate]) {
      dateWiseData[currentDate] = {
        members: [],
        deposits: []
      };
    }
    dateWiseData[currentDate].members.push(...masterData.members);

    // Refresh UI
    refreshMembers();
    
    showNotification(`✅ Import berhasil! ${masterData.members.length} member baru ditambahkan`);

    // Tampilkan konfirmasi
    setTimeout(() => {
      alert(`✅ IMPORT BERHASIL!\n\n${masterData.members.length} data member baru berhasil diimport dari Master Admin.\n\nData sekarang sudah diperbarui dan siap digunakan.`);
    }, 500);

  } catch (error) {
    console.error('Error importing from master:', error);
    alert('❌ Error import data master: ' + error.message);
    showNotification('❌ Gagal import data master');
  }
}

// ==================== KODE YANG SUDAH ADA (DENGAN PERBAIKAN ANIMASI) ====================
let state = { members: [], deposits: [] };
let chartInstance = null;
let currentView = 'daily';
let dateWiseData = {};

function getCurrentDataSet() {
  const currentDate = getCurrentViewDate();
  
  if (!dateWiseData[currentDate]) {
    dateWiseData[currentDate] = {
      members: [],
      deposits: []
    };
  }
  
  return dateWiseData[currentDate];
}

function getFilteredMembers() {
  const currentDataSet = getCurrentDataSet();
  return currentDataSet.members || [];
}

function getFilteredDeposits() {
  const currentDataSet = getCurrentDataSet();
  return currentDataSet.deposits || [];
}

function initializeDailySystem() {
  const today = getCurrentLocalDate();
  const lastViewDate = localStorage.getItem('lastViewDate');
  
  if (lastViewDate !== today) {
    localStorage.setItem('lastViewDate', today);
    localStorage.setItem('currentViewDate', today);
    showNotification('🔄 Sistem direset untuk tanggal ' + formatDateForDisplay(today));
  } else {
    const savedDate = localStorage.getItem('currentViewDate') || today;
    setCurrentViewDate(savedDate);
  }
}

function resetToToday() {
  const today = getCurrentLocalDate();
  setCurrentViewDate(today);
  
  document.getElementById('fromDate').value = '';
  document.getElementById('toDate').value = '';
  document.getElementById('depositDate').value = '';
  
  refreshMembers();
  refreshDeposits();
  refreshChart();
  refreshDailySummary();
  
  showNotification('📅 Kembali ke data hari ini: ' + formatDateForDisplay(today));
}

function setCurrentViewDate(date) {
  localStorage.setItem('currentViewDate', date);
  updateDateDisplay(date);
}

function updateDateDisplay(date) {
  const today = getCurrentLocalDate();
  const isToday = date === today;
  
  const dateDisplayElement = document.getElementById('currentDateDisplay');
  const displayText = formatDateForDisplay(date) + (isToday ? ' (HARI INI)' : '');
  dateDisplayElement.textContent = displayText;
  
  const infoElement = document.getElementById('dateRangeInfo');
  if (isToday) {
    infoElement.innerHTML = `📅 <strong>HARI INI</strong> - ${formatDateForDisplay(date)} - Mulai data fresh`;
    infoElement.style.background = '#f0f9ff';
    infoElement.style.borderColor = '#bae6fd';
    infoElement.style.color = '#0369a1';
  } else {
    infoElement.innerHTML = `📅 <strong>MODE VIEW TANGGAL:</strong> ${formatDateForDisplay(date)}`;
    infoElement.style.background = '#fef3c7';
    infoElement.style.borderColor = '#fcd34d';
    infoElement.style.color = '#92400e';
  }
}

function getCurrentViewDate() {
  return localStorage.getItem('currentViewDate') || getCurrentLocalDate();
}

function goToPreviousDay() {
  const currentDate = new Date(getCurrentViewDate());
  currentDate.setDate(currentDate.getDate() - 1);
  const prevDate = currentDate.toISOString().split('T')[0];
  navigateToDate(prevDate);
}

function goToNextDay() {
  const currentDate = new Date(getCurrentViewDate());
  currentDate.setDate(currentDate.getDate() + 1);
  const nextDate = currentDate.toISOString().split('T')[0];
  
  const today = getCurrentLocalDate();
  if (nextDate > today) {
    showNotification('Tidak bisa navigasi ke tanggal masa depan');
    return;
  }
  
  navigateToDate(nextDate);
}

function goToToday() {
  resetToToday();
}

function navigateToDate(targetDate) {
  setCurrentViewDate(targetDate);
  refreshMembers();
  refreshDeposits();
  refreshChart();
  refreshDailySummary();
  showNotification('📅 Melihat data tanggal: ' + formatDateForDisplay(targetDate));
}

function showNotification(message) {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #10b981;
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    font-size: 14px;
    max-width: 300px;
    animation: slideInRight 0.3s ease-out;
  `;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    if (notification.parentNode) {
      notification.style.animation = 'slideOutRight 0.3s ease-in';
      setTimeout(() => {
        if (notification.parentNode) {
          document.body.removeChild(notification);
        }
      }, 300);
    }
  }, 3000);
}

// Tambahkan style untuk animasi notifikasi
const notificationStyle = document.createElement('style');
notificationStyle.textContent = `
  @keyframes slideInRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes slideOutRight {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }
`;
document.head.appendChild(notificationStyle);

function formatDateForDisplay(dateString) {
  if (!dateString) return '-';
  
  const date = new Date(dateString);
  return date.toLocaleDateString('id-ID', {
    day: 'numeric',
    month: 'long',
    year: 'numeric',
    timeZone: 'Asia/Jakarta'
  });
}

function getCurrentLocalDate() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

async function doLogin() {
  const username = document.getElementById('loginUser').value.trim();
  const password = document.getElementById('loginPass').value;

  // Tambahkan loading state pada tombol login
  const loginButton = document.getElementById('loginButton');
  setButtonLoading(loginButton, true);

  try {
    const { data: admins, error } = await supabase
      .from('admins')
      .select('*')
      .eq('username', username)
      .eq('password', password);

    if (error) throw error;

    if (admins && admins.length > 0) {
      currentAdmin = admins[0];
      document.getElementById('loginMsg').textContent = 'Login sukses';
      setTimeout(() => {
        openMain(currentAdmin);
        setButtonLoading(loginButton, false);
      }, 500);
    } else {
      document.getElementById('loginMsg').textContent = 'Login gagal. Username/password salah';
      setButtonLoading(loginButton, false);
    }
  } catch (error) {
    console.error('Login error:', error);
    document.getElementById('loginMsg').textContent = 'Error saat login';
    setButtonLoading(loginButton, false);
  }
}

function showLogin() {
  document.getElementById('mainUI').style.display = 'none';
  document.getElementById('loginBox').style.display = 'block';
  document.getElementById('signedIn').style.display = 'none';
  document.getElementById('signedOut').style.display = 'block';
}

function logout() {
  currentAdmin = null;
  localStorage.removeItem('currentAdminUser');
  showLogin();
}

function openMain(user) {
  document.getElementById('loginBox').style.display = 'none';
  document.getElementById('mainUI').style.display = 'block';
  document.getElementById('signedIn').style.display = 'flex';
  document.getElementById('signedOut').style.display = 'none';
  document.getElementById('adminName').textContent = user.name;

  localStorage.setItem('currentAdminUser', JSON.stringify(user));
  
  initializeDailySystem();
  loadAdminData();
  
  // Inisialisasi animasi tombol setelah UI utama dimuat
  setTimeout(initializeButtonAnimations, 100);
}

async function loadAdminData() {
  if (!currentAdmin) return;

  try {
    const { data: allMembers, error: membersError } = await supabase
      .from('members')
      .select('*')
      .eq('admin_username', currentAdmin.username)
      .order('last_deposit', { ascending: false });

    if (membersError) throw membersError;

    const { data: allDeposits, error: depositsError } = await supabase
      .from('deposits')
      .select('*')
      .eq('admin_username', currentAdmin.username)
      .order('date', { ascending: false });

    if (depositsError) throw depositsError;

    state.members = allMembers || [];
    state.deposits = allDeposits || [];

    organizeDataByDate();

    document.getElementById('fromDate').value = '';
    document.getElementById('toDate').value = '';
    document.getElementById('depositDate').value = '';

    refreshMembers();
    refreshDeposits();
    refreshChart();
    refreshDailySummary();

  } catch (error) {
    console.error('Error loading data:', error);
  }
}

function organizeDataByDate() {
  dateWiseData = {};
  
  state.deposits.forEach(deposit => {
    if (!dateWiseData[deposit.date]) {
      dateWiseData[deposit.date] = {
        members: [],
        deposits: []
      };
    }
    dateWiseData[deposit.date].deposits.push(deposit);
  });
  
  state.members.forEach(member => {
    const memberDate = member.created_at ? member.created_at.split('T')[0] : getCurrentLocalDate();
    
    if (!dateWiseData[memberDate]) {
      dateWiseData[memberDate] = {
        members: [],
        deposits: []
      };
    }
    dateWiseData[memberDate].members.push(member);
  });
}

// ... (fungsi-fungsi lainnya tetap sama seperti sebelumnya)

async function addDeposit() {
  const memberId = document.getElementById('depositMember').value;
  const manualName = document.getElementById('depositManual').value.trim();
  const amount = getCleanAmount();
  let depositDate = document.getElementById('depositDate').value;

  if (!amount) {
    alert('Nominal wajib diisi');
    return;
  }

  if (!depositDate) {
    depositDate = getCurrentViewDate();
  }

  let memberName = '';
  let finalMemberId = memberId;

  if (memberId) {
    const member = state.members.find(m => m.id === memberId);
    if (member) {
      memberName = member.name;
    }
  } else if (manualName) {
    memberName = manualName;
    finalMemberId = 'manual_' + uid();
  } else {
    alert('Pilih member atau isi nama manual');
    return;
  }

  // Tambahkan loading state pada tombol tambah deposit
  const addDepositButton = document.getElementById('addDepositButton');
  setButtonLoading(addDepositButton, true);

  try {
    const depositData = {
      id: 'd' + uid(),
      member_id: finalMemberId,
      member_name: memberName,
      amount: amount,
      date: depositDate,
      admin_username: currentAdmin.username,
      created_at: new Date().toISOString()
    };

    const { error } = await supabase
      .from('deposits')
      .insert([depositData]);

    if (error) throw error;

    state.deposits.push(depositData);
    
    if (!dateWiseData[depositDate]) {
      dateWiseData[depositDate] = {
        members: [],
        deposits: []
      };
    }
    dateWiseData[depositDate].deposits.push(depositData);

    document.getElementById('depositAmount').value = '';
    document.getElementById('depositManual').value = '';
    document.getElementById('depositMember').value = '';
    document.getElementById('depositDate').value = '';

    refreshDeposits();
    refreshChart();
    refreshDailySummary();
    refreshMembers();

    showNotification('✅ Deposit berhasil ditambahkan!');
    setButtonLoading(addDepositButton, false);

  } catch (error) {
    console.error('Error adding deposit:', error);
    alert('Error menambahkan deposit');
    setButtonLoading(addDepositButton, false);
  }
}

// ... (fungsi-fungsi lainnya tetap sama)

// Inisialisasi ketika DOM siap
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('fromDate').value = '';
  document.getElementById('toDate').value = '';

  initializeDailySystem();

  const savedUser = localStorage.getItem('currentAdminUser');
  if (savedUser) {
    try {
      currentAdmin = JSON.parse(savedUser);
      openMain(currentAdmin);
    } catch (e) {
      localStorage.removeItem('currentAdminUser');
    }
  }
  
  // Inisialisasi animasi tombol
  initializeButtonAnimations();
});

// Fungsi-fungsi lainnya tetap sama seperti sebelumnya...
// (downloadForGoogleDrive, refreshMembers, refreshDeposits, refreshChart, dll.)

</script>
</body>
</html>
